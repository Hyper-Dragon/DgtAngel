<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="description" content="DGT Cherub need to be running..." />
    <meta charset="utf-8">
    <title>DGT Angel Clock</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Hyper-Dragon">
    <link rel='favicon' type='image/png' href='/DgtVirtualClock/Images/favicon.png'>
</head>

<body>
    <div class="container">
        <h4>White:&nbsp;<i id='white-clock'>0:00:00</i>&nbsp;Black:&nbsp;<i id='black-clock'>0:00:00</i></h4>
        <table>
            <tr><td></td><td>Remote Board&nbsp;<i hidden id='remote-fen'>-</i></td><td>Local Board&nbsp;<i hidden id='local-fen'>-</i></td></tr>
            <tr><td><i id='is-white-to-play'>No Game</i></td><td><img id="remote-board-img" src="" /></td><td><img id="local-board-img" src="" /></td></tr>
        </table>
        <hr />
        <small>Connection Status&nbsp;<i id='con-state'>Not Connected</i>&nbsp;Last Update Date&nbsp;<i id='last-update-day'>Never</i>&nbsp;Last Update Time&nbsp;<i id='last-update-time'>Never</i></small>
        <!--<h2><img src="/DgtVirtualClock/Images/blah.jpg" /></h2>-->
    </div>

    <script>
        start = Date.now();
        whiteClockMsRemaining = 0;
        blackClockMsRemaining = 0;
        isGameInProgress = false;
        isWhiteToPlay = true;
        isTimerSuspended = false;

        function timeRemaining(clockId, diff) {
            display = document.getElementById(clockId);

            if (diff <= 0) {
                display.textContent = "0:00:00";
            } else {
                totalMinutes = (diff / 60) | 0;

                hours = (totalMinutes / 60) | 0;
                minutes = (totalMinutes % 60) | 0;
                seconds = (diff % 60) | 0;

                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;

                display.textContent = hours + ":" + minutes + ":" + seconds;
            }
        }

        function timer() {
            if (isGameInProgress) {
                if (isTimerSuspended == false) {
                    // get the number of seconds that have elapsed since update
                    if (isWhiteToPlay == true) {
                        document.getElementById('is-white-to-play').textContent = "White To Play";

                        timeRemaining('white-clock', (whiteClockMsRemaining / 1000) - (((Date.now() - start) / 1000) | 0));
                        timeRemaining('black-clock', (blackClockMsRemaining / 1000));
                    } else {
                        document.getElementById('is-white-to-play').textContent = "Black To Play";

                        timeRemaining('white-clock', (whiteClockMsRemaining / 1000));
                        timeRemaining('black-clock', (blackClockMsRemaining / 1000) - (((Date.now() - start) / 1000) | 0));
                    }
                }
            } else {
                document.getElementById('is-white-to-play').textContent = "No Game";
                document.getElementById('white-clock').textContent = "0:00:00";
                document.getElementById('black-clock').textContent = "0:00:00";
            }
        }

        window.onload = function () {
            var source = new EventSource('/DgtVirtualClock/GetStuff/' + (new Date()).getTime());

            source.onopen = function (event) { document.getElementById('con-state').innerHTML = 'CONNECTED'; timer(); setInterval(timer, 1000); };
            source.onerror = function (event) { document.getElementById('con-state').innerHTML = 'DISCONNECTED'; source.close(); }

            source.onmessage = function (event) {
                //console.log(event.data);
                const obj = JSON.parse(event.data);

                switch (obj.MessageType) {
                    case "OnLocalFenChange":
                        document.getElementById('local-fen').textContent = obj.BoardFen;
                        document.getElementById('local-board-img').src = 'https://www.chess.com/dynboard?board=green&piece=space&size=0&fen=' + obj.BoardFen;
                        break;
                    case "OnRemoteFenChange":
                        document.getElementById('remote-fen').textContent = obj.BoardFen;
                        document.getElementById('remote-board-img').src = 'https://www.chess.com/dynboard?board=green&piece=space&size=0&fen=' + obj.BoardFen;
                        break;
                    case "OnClockChange":
                        isTimerSuspended = true;
                        start = Date.now();
                        whiteClockMsRemaining = obj.WhiteClockMsRemaining;
                        blackClockMsRemaining = obj.BlackClockMsRemaining;
                        isGameInProgress = obj.IsGameActive;
                        isWhiteToPlay = obj.IsWhiteToPlay;
                        isTimerSuspended = false;
                        break;
                    case "Keep-Alive":
                        //console.log("...Still Reunning");
                        break;
                    default:
                        console.error("Invalid message type recieved from DGT Cherub");
                        break;
                }

                document.getElementById('last-update-day').textContent = obj.ResponseAtData;
                document.getElementById('last-update-time').textContent = obj.ResponseAtTime;
            }
        }
    </script>
</body>

</html>